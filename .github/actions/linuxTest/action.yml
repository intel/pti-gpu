name: 'Linux tests for PTI'
description: |
  Run the tests with a partition that is expected to ALWAYS succeed and
  another partition that MAY fail. The latter is designated as Quarantine.
inputs:
  wdir:
    description: Working directory
    required: true
  preset:
    description: Preset used in the build to be tested.
    required: true
  adjust-test-bmg:
    description: "Exclude known failing test for bmg and oneAPI-2025.3"
    default: false
    type: boolean

runs:
  using: "composite"
  steps:

    - name: Tests that MUST succeed.
      working-directory: ${{ inputs.wdir }}
      shell: bash
      run: |
        #
        # This test is NOT CRITICAL.
        # validate-sycl-ur-api-ids-test is known to fail at this stage
        # of development and will be fixed in due course.
        #
        source /opt/intel/oneapi/setvars.sh

        #
        # PTI-297.
        # This test is NOT CRITICAL.
        # Tests for bmg+2025.3 are partitioned to have them pass. Notice
        # that a number of them require SYCL_UR_USE_LEVEL_ZERO_V2=0
        # which is a workaround until we resolve PTI-297
        #
        if [[ "${{ inputs.adjust-test-2025-3 }}" == "true" && "${{ inputs.adjust-test-bmg }}" == "true" ]]; then
          SYCL_UR_USE_LEVEL_ZERO_V2=0 ctest --preset linux-oneAPI-release -R "RuntimeOpsUnsetMainFixtureTest.NumberOfExpectedMemoryRecordsAfterStopTracing|RuntimeOpsUnsetMainFixtureTest.NumberOfExpectedKernelRecordsAfterStopTracing|RuntimeOpsSetOffMainFixtureTest.NumberOfExpectedMemoryRecordsAfterStopTracing|RuntimeOpsSetOffMainFixtureTest.NumberOfExpectedKernelRecordsAfterStopTracing|RuntimeOpsSetOnMainFixtureTest.NumberOfExpectedMemoryRecordsAfter"
          ctest --preset linux-oneAPI-release -E "RuntimeOpsUnsetMainFixtureTest.NumberOfExpectedMemoryRecordsAfterStopTracing|RuntimeOpsUnsetMainFixtureTest.NumberOfExpectedKernelRecordsAfterStopTracing|RuntimeOpsSetOffMainFixtureTest.NumberOfExpectedMemoryRecordsAfterStopTracing|RuntimeOpsSetOffMainFixtureTest.NumberOfExpectedKernelRecordsAfterStopTracing|RuntimeOpsSetOnMainFixtureTest.NumberOfExpectedMemoryRecordsAfterStopTracing|RuntimeOpsSetOnMainFixtureTest.NumberOfExpectedKernelRecordsAfterStopTracing|NoKernelOverlapAndGapInSubmittingTests|perf-prof-gpu-overhead|validate-sycl-ur-api-ids-test|mt-awk-test|perf*"
        else
          ctest --output-on-failure --preset ${{ inputs.preset }} -LE performance
        fi

    - name: Quarantined tests # flaky tests
      continue-on-error: true
      working-directory: ${{ inputs.wdir }}
      shell: bash
      run: |
        source /opt/intel/oneapi/setvars.sh

        if ctest --output-on-failure --preset ${{ inputs.preset }} -L performance; then
          echo "Test status: 0"
          echo "Quarantine tests all pass."
        else
          echo "Test status: 1"
          echo "::warning::Quarantine tests presented failures."
        fi
        exit 0
